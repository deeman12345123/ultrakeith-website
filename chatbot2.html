<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KeithGPT - Battle Test</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            background: #0a0a0a;
            color: white;
            height: 100vh;
            display: flex;
        }
        
        .sidebar {
            width: 300px;
            background: #1a1a1a;
            padding: 20px;
            border-right: 1px solid #333;
        }
        
        .logo {
            color: #ffd700;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .battle-setup {
            margin-bottom: 30px;
        }
        
        .battle-setup h3 {
            color: #ffd700;
            margin-bottom: 15px;
        }
        
        .fighter-select {
            margin-bottom: 15px;
        }
        
        .fighter-select label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }
        
        .fighter-select select {
            width: 100%;
            padding: 10px;
            background: #2a2a2a;
            color: white;
            border: 1px solid #444;
            border-radius: 5px;
        }
        
        .start-battle {
            width: 100%;
            padding: 15px;
            background: #ffd700;
            color: black;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
        }
        
        .start-battle:hover {
            background: #ffed4e;
        }
        
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0f0f0f;
        }
        
        .chat-header {
            padding: 20px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            color: #ffd700;
            font-size: 18px;
            font-weight: bold;
        }
        
        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .message {
            margin-bottom: 20px;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 10px;
            border-left: 4px solid #ffd700;
        }
        
        .battle-message {
            background: #2a1a00;
            border-left: 4px solid #ffd700;
        }
        
        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .round-badge {
            background: #ffd700;
            color: black;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
        
        .character-name {
            color: #ffd700;
        }
        
        .verse {
            line-height: 1.6;
            white-space: pre-line;
            font-size: 15px;
        }
        
        .system-message {
            background: #0a2a0a;
            border-left: 4px solid #00ff00;
            text-align: center;
            font-style: italic;
        }
        
        .loading {
            background: #2a2a0a;
            border-left: 4px solid #ffff00;
            text-align: center;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">KEITHGPT</div>
        
        <div class="battle-setup">
            <h3>🥊 BATTLE SETUP</h3>
            
            <div class="fighter-select">
                <label>Fighter 1:</label>
                <select id="fighter1">
                    <option value="kool-keith">Kool Keith</option>
                    <option value="dr-octagon">Dr. Octagon</option>
                    <option value="dr-dooom">Dr. Dooom</option>
                    <option value="black-elvis">Black Elvis</option>
                </select>
            </div>
            
            <div class="fighter-select">
                <label>Fighter 2:</label>
                <select id="fighter2">
                    <option value="dr-octagon" selected>Dr. Octagon</option>
                    <option value="kool-keith">Kool Keith</option>
                    <option value="dr-dooom">Dr. Dooom</option>
                    <option value="black-elvis">Black Elvis</option>
                </select>
            </div>
            
            <button class="start-battle" onclick="startBattle()">START BATTLE</button>
        </div>
    </div>
    
    <div class="main-chat">
        <div class="chat-header">
            <span id="status">Ready to Battle</span>
        </div>
        
        <div class="messages" id="messages">
            <div class="message system-message">
                <div>Welcome to KeithGPT Battle Arena!</div>
                <div>Select two fighters and click START BATTLE to watch them go head-to-head.</div>
            </div>
        </div>
    </div>

    <script>
        // API Key
        const API_KEY = 'AIzaSyDnMpSoawXZ-_LE9ZXAsFJ41JXmbN0VDW0';
        
        // Characters
        const characters = {
            'kool-keith': 'Kool Keith',
            'dr-octagon': 'Dr. Octagon', 
            'dr-dooom': 'Dr. Dooom',
            'black-elvis': 'Black Elvis'
        };
        
        // Battle topics
        const topics = [
            "lyrical supremacy",
            "hip-hop innovation", 
            "underground authenticity",
            "New York legacy",
            "mic skills"
        ];
        
        // Battle state
        let battleActive = false;
        let currentRound = 1;
        let currentFighter = 1;
        let topic = '';
        
        function addMessage(content, type = 'message', character = '', round = 0) {
            const messages = document.getElementById('messages');
            const div = document.createElement('div');
            
            if (type === 'battle') {
                div.className = 'message battle-message';
                div.innerHTML = `
                    <div class="message-header">
                        <span class="round-badge">Round ${round}</span>
                        <span class="character-name">${character}</span>
                    </div>
                    <div class="verse">${content}</div>
                `;
            } else if (type === 'system') {
                div.className = 'message system-message';
                div.innerHTML = `<div>${content}</div>`;
            } else if (type === 'loading') {
                div.className = 'message loading';
                div.innerHTML = `<div>${content}</div>`;
            }
            
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
            
            console.log(`Added ${type} message:`, content);
        }
        
        async function callBattleAPI(character, topic, round) {
            console.log(`=== CALLING API ===`);
            console.log(`Character: ${character}`);
            console.log(`Topic: ${topic}`);
            console.log(`Round: ${round}`);
            
            const prompt = `You are ${characters[character]} in a rap battle. This is round ${round} of 3. The topic is "${topic}". Write a fierce 4-6 line rap verse that showcases your skills and disses your opponent. Use your signature style. Be confrontational and competitive. Format as a rap verse with line breaks. Make it punchy and memorable.`;
            
            console.log(`Prompt: ${prompt}`);
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            role: 'user',
                            parts: [{ text: prompt }]
                        }],
                        generationConfig: {
                            temperature: 0.9,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 200
                        },
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                        ]
                    })
                });
                
                console.log(`Response status: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`API Error: ${response.status} - ${errorText}`);
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Full API response:', data);
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    const verse = data.candidates[0].content.parts[0].text;
                    console.log(`Extracted verse: ${verse}`);
                    return verse;
                } else {
                    console.error('No content in response');
                    console.log('Response structure:', JSON.stringify(data, null, 2));
                    throw new Error('No content in API response');
                }
                
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }
        
        async function startBattle() {
            console.log('=== STARTING BATTLE ===');
            
            const fighter1 = document.getElementById('fighter1').value;
            const fighter2 = document.getElementById('fighter2').value;
            
            if (fighter1 === fighter2) {
                alert('Please select different fighters!');
                return;
            }
            
            battleActive = true;
            currentRound = 1;
            currentFighter = 1;
            topic = topics[Math.floor(Math.random() * topics.length)];
            
            console.log(`Fighter 1: ${fighter1}`);
            console.log(`Fighter 2: ${fighter2}`);
            console.log(`Topic: ${topic}`);
            
            // Clear messages
            document.getElementById('messages').innerHTML = '';
            document.getElementById('status').textContent = 'Battle in Progress...';
            
            // Add battle intro
            addMessage(`🥊 BATTLE ROYALE: ${characters[fighter1]} vs ${characters[fighter2]}\n\nTopic: "${topic}"\n\n3 rounds of lyrical warfare begins NOW!`, 'system');
            
            // Start the battle
            battleLoop(fighter1, fighter2);
        }
        
        async function battleLoop(fighter1, fighter2) {
            console.log(`=== BATTLE LOOP ===`);
            console.log(`Round: ${currentRound}`);
            console.log(`Current fighter: ${currentFighter}`);
            
            if (currentRound > 3) {
                addMessage('🏆 BATTLE COMPLETE! Both warriors showed incredible skill!', 'system');
                document.getElementById('status').textContent = 'Battle Complete';
                battleActive = false;
                return;
            }
            
            const fighter = currentFighter === 1 ? fighter1 : fighter2;
            const fighterName = characters[fighter];
            
            console.log(`${fighterName} is up for round ${currentRound}`);
            
            // Show loading
            addMessage(`${fighterName} is dropping their verse...`, 'loading');
            
            try {
                // Call API
                const verse = await callBattleAPI(fighter, topic, currentRound);
                
                // Remove loading message
                const messages = document.getElementById('messages');
                messages.removeChild(messages.lastChild);
                
                // Add battle verse
                addMessage(verse, 'battle', fighterName, currentRound);
                
                // Switch to next fighter or round
                if (currentFighter === 1) {
                    currentFighter = 2;
                } else {
                    currentFighter = 1;
                    currentRound++;
                }
                
                // Continue battle after delay
                setTimeout(() => battleLoop(fighter1, fighter2), 3000);
                
            } catch (error) {
                console.error('Battle error:', error);
                
                // Remove loading message
                const messages = document.getElementById('messages');
                messages.removeChild(messages.lastChild);
                
                // Show error and retry
                addMessage(`${fighterName} had technical difficulties. Retrying...`, 'system');
                setTimeout(() => battleLoop(fighter1, fighter2), 2000);
            }
        }
        
        console.log('Battle system initialized');
    </script>
</body>
</html>
